# üìä –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É UPAK Backend

## üéØ –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ webhook'–æ–≤
- **Rate limiting**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Replay –∞—Ç–∞–∫–∏**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞**: –°—Ä–µ–¥–Ω–∏–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π response time
- **Throughput**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
- **Redis –æ–ø–µ—Ä–∞—Ü–∏–∏**: –í—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
- **Telegram Bot**: –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **Uptime**: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞
- **Error rate**: –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫
- **Retry –æ–ø–µ—Ä–∞—Ü–∏–∏**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- **Graceful degradation**: –ê–∫—Ç–∏–≤–∞—Ü–∏—è fallback —Ä–µ–∂–∏–º–æ–≤

## üìà –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
```python
# –ü—Ä–∏–º–µ—Ä –ª–æ–≥-–∑–∞–ø–∏—Å–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
{
  "timestamp": "2025-08-06T17:23:25Z",
  "level": "INFO",
  "category": "security",
  "severity": "medium",
  "message": "HMAC validation successful",
  "context": {
    "endpoint": "/yookassa-webhook",
    "user_id": null,
    "request_id": "req_123456",
    "ip_address": "192.168.1.1"
  },
  "performance": {
    "duration_ms": 45,
    "memory_mb": 128
  }
}
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis
```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Redis
redis-cli info stats          # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
redis-cli info memory         # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
redis-cli info clients        # –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
redis-cli info replication    # –°—Ç–∞—Ç—É—Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
redis-cli slowlog get 10      # –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```

### 3. –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
```bash
# CPU –∏ –ø–∞–º—è—Ç—å
htop
free -h
df -h

# –°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
netstat -tulpn | grep :8000
ss -tulpn | grep :8000

# –ü—Ä–æ—Ü–µ—Å—Å—ã Python
ps aux | grep python
pgrep -f uvicorn
```

## üö® –ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
1. **–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** (HTTP 5xx > 5%)
2. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** (connection errors)
3. **HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–∞** (> 10 —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É)
4. **–í—ã—Å–æ–∫–∏–π error rate** (> 10% –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç)
5. **–ü–∞–º—è—Ç—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è** (> 90% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

### –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
1. **–í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞** (> 2 —Å–µ–∫—É–Ω–¥)
2. **Rate limiting –∞–∫—Ç–∏–≤–µ–Ω** (> 50 –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ –º–∏–Ω—É—Ç—É)
3. **Telegram Bot –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** (retry attempts)
4. **–î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è** (> 80% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
5. **–ú–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ Redis** (> 100ms)

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤
```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥ —Ñ–∞–π–ª
tail -f logs/upak.log

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—é
grep "ERROR" logs/upak.log
grep "CRITICAL" logs/upak.log

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
grep "security" logs/upak.log
grep "telegram" logs/upak.log
grep "database" logs/upak.log
```

### 2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```bash
# –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
grep "duration_ms.*[5-9][0-9][0-9]" logs/upak.log

# –û—à–∏–±–∫–∏ –ø–æ endpoints
grep "error" logs/upak.log | grep -o '"endpoint":"[^"]*"' | sort | uniq -c

# Top IP –∞–¥—Ä–µ—Å–∞
grep "ip_address" logs/upak.log | grep -o '"ip_address":"[^"]*"' | sort | uniq -c | sort -nr
```

## üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```bash
#!/bin/bash
# monitoring.sh

echo "=== UPAK Backend Health Check ==="
echo "Timestamp: $(date)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
if curl -sf http://localhost:8000/health > /dev/null; then
    echo "‚úÖ Service: UP"
else
    echo "‚ùå Service: DOWN"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
if redis-cli ping > /dev/null 2>&1; then
    echo "‚úÖ Redis: UP"
else
    echo "‚ùå Redis: DOWN"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç)
ERROR_COUNT=$(grep "ERROR\|CRITICAL" logs/upak.log | grep "$(date -d '5 minutes ago' '+%Y-%m-%d %H:%M')" | wc -l)
echo "‚ö†Ô∏è  Errors (last 5 min): $ERROR_COUNT"

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
MEMORY=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
echo "üíæ Memory usage: ${MEMORY}%"

echo "=========================="
```

## üîß Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

1. **–í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É CPU/–ø–∞–º—è—Ç–∏
   - –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

2. **–û—à–∏–±–∫–∏ HMAC –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å YOOKASSA_WEBHOOK_SECRET
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

3. **Telegram Bot –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TELEGRAM_BOT_TOKEN
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limits Telegram API

4. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞: `systemctl status redis`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Redis: `/var/log/redis/redis-server.log`

## üìã –ß–µ–∫-–ª–∏—Å—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å error rate –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Redis
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É Telegram Bot
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å backup'—ã –∏ –ª–æ–≥–∏ —Ä–æ—Ç–∞—Ü–∏–∏

---
**–û–±–Ω–æ–≤–ª–µ–Ω–æ**: 6 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–í–µ—Ä—Å–∏—è**: v1.1 –¥–ª—è UPAK Backend —Å –ø–æ–ª–Ω—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º